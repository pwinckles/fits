# This file can be used to create a FITS Docker image.
#
# Usage:
#   # Build the image
#   docker build -f Dockerfile -t fits .
#
#   # Build the image with version tags (replace with the correct version)
#   docker build -f Dockerfile -t fits:latest -t fits:1.6.0 .
#
#   # Run FITS on a file
#   docker run --rm -v `pwd`:/work:z fits -i file.txt
#
#   # Run a specific version of FITS on a file
#   docker run --rm -v `pwd`:/work:z fits:1.6.0 -i file.txt
#
#   # Run FITS on a directory
#   docker run --rm -v `pwd`:/work:z fits -r -n -i in-dir -o out-dir
#
#   # Run FITS with alternate configuration
#   docker run --rm -v `pwd`:/work:z fits -f fits-custom.xml -i file.txt

FROM docker.io/eclipse-temurin:17-jre-focal

ARG FILE_VERSION=5.41
ARG FILE_SHA256=13e532c7b364f7d57e23dfeea3147103150cb90593a57af86c10e4f6e411603f

RUN apt-get update && \
    apt-get install -yqq \
    # exiftool dependencies https://github.com/exiftool/exiftool
    libarchive-zip-perl \
    libio-compress-perl \
    libcompress-raw-zlib-perl \
    libcompress-bzip2-perl \
    libcompress-raw-bzip2-perl \
    libio-digest-perl \
    libdigest-md5-file-perl \
    libdigest-perl-md5-perl \
    libdigest-sha-perl \
    libposix-strptime-perl \
    libunicode-linebreak-perl\
    # file dependencies
    make \
    gcc \
    # mediainfo dependencies
    libmms0 \
    libcurl3-gnutls \
    && rm -rf /var/lib/apt/lists/*

# Install file https://github.com/file/file
RUN cd /var/tmp && \
    curl -so file-${FILE_VERSION}.tar.gz https://astron.com/pub/file/file-${FILE_VERSION}.tar.gz && \
    echo "${FILE_SHA256}  file-${FILE_VERSION}.tar.gz" | sha256sum --check && \
    tar xzf file-${FILE_VERSION}.tar.gz && \
    cd file-${FILE_VERSION} && \
    ./configure && \
    make -j4 && \
    make install && \
    ldconfig && \
    cd .. && \
    rm -rf file-${FILE_VERSION}*

# Install FITS
ADD . /opt/fits

# Bind the current working directory here so that FITS can access files on the host
WORKDIR /work

ENTRYPOINT ["/opt/fits/fits.sh"]
